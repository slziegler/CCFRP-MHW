---
title: "CCFRP_MHWAnalyses"
author: "Shelby Ziegler"
date: "8/24/2021"
output:
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, error=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)


library(tidyverse) # For data manipulation and summarization
library(plotrix) #To use standard error calculation
library(cowplot) #For grouping plots
library(scales) #For editing axis scales
library(vegan) #For multivariate analyses
library(rstatix) #For running ANCOVA
library(ggpmisc) #adding equation and r2 to figures

#Set alpha level for calculating CIs
alpha=0.5
#Define formula for text on plots
formula<-y~x
#Set plot theme and base text size
theme_set(theme_classic(base_size=16))
#Set seed for consistent multivariate outputs
set.seed(74)
```

First examine environmental variables across MHW time periods (before, during and after) and Site (MPA vs Reference)
Pull out specific species and run models with different oceanographic indices - MOCI, temp, upwelling, etc

```{r}
#Read in extracted environmental data for each CCFRP grid cell
enviro<-read.csv('2020-Raw_Data/sumenvironmentaldata.csv')%>%
  rename(Site=MPA_Status)%>%
  filter(Area=="Ano Nuevo" |Area=="Point Lobos" | Area=="Piedras Blancas" | Area=="Point Buchon")

#Read in Multivariate Oceanographic Climate Indicator
moci<-read.csv("Raw_Data /CA-MOCI.csv")

#Filter out data after 2004 for July, August and September
moci<- moci%>%
  filter(Season=="JAS")%>%
  filter(Year>2004)%>%
  select(Year, Central.California..34.5.38N.)%>%
  rename(MOCI=Central.California..34.5.38N.)


#Combine environmental data and MOCI
envall<-left_join(enviro, moci)%>%
  rename(Site=MPA_Status)

#Break years into groups "Before", "During" and "After" the marine heatwave
envall<-envall%>%
  mutate(mhw= ifelse(Year < 2014, "Before",
               ifelse(Year > 2016 , "After", "During")))

#Reorder heatwave groups 
envall$mhw<-factor(envall$mhw, levels=c("Before", "During", "After"))

#Conduct 2-way interactive ANOVAs to determine the differences in envrionmental variables in relation to MHW and geographic location (Ano Nuevo, Point Lobos, Piedras Blancas and Point Buchon).

#Mean sea surface temperature
an1<-aov(meansst~mhw*Area, data=envall)
summary(an1)
TukeyHSD(an1)  

#Maximum sea surface temperature
an2<-aov(meanmaxsst~mhw*Area, data=envall)
summary(an2)
TukeyHSD(an2)  

#Net primary production
an3<-aov(meannpp~mhw*Area, data=envall)
summary(an3)
TukeyHSD(an3) 

#Wind speed
an4<-aov(meanws~mhw*Area, data=envall)
summary(an4)
TukeyHSD(an4) 

#Significant wave height
an5<-aov(meanwh~mhw*Area, data=envall)
summary(an5)
TukeyHSD(an5) 

```

Read in data frames 

```{r}
#Read in CPUE data
cpue<-read.csv('2020-Raw_Data/CPUE.per.IDcell_2020.csv')
bpue<-read.csv('2020-Raw_Data/BPUE.per.IDcell_2020.csv')
mpadata<-read.csv('2020-Raw_Data/mpa-data-2.csv')
traits<-read.csv("2020-Raw_Data/CCFRP-FishTraits.csv")

#Select key variables from 'mpadata' and rename MPA.Group to Area
mpainfo<-mpadata%>%
  select(MPA.Group, Region, island.mainland, Pairedsmr.smca, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude)%>%
  rename(Area = MPA.Group )
```

Calculate diversity indices with CPUE data

```{r}
#Gather data into long format
cpue<-cpue%>%
  group_by(Area, Site, Year)%>%
  gather(species, cpue,-ID.Cell.per.Trip,  -Area, -Site, -Year, -Total.Angler.Hours, -Grid.Cell.ID)


#Combine Blue and Deacon Rockfish into one complex
cpue$species <- recode_factor(cpue$species, Blue.Rockfish = "Blue.Deacon.Rockfish", 
                                Deacon.Rockfish = "Blue.Deacon.Rockfish")

#Match the MPA information, envrionmental data and species traits to CPUE data. 
cpuematch<-inner_join(cpue, mpainfo, by = 'Area')
cpuematch1<-left_join(cpuematch, enviro, by = c("Area", "Site", "Year"))
cpuematch1<-left_join(cpuematch1, traits, by = "species")%>%
  #filter(Central.Region=="TRUE")%>%
  group_by(ID.Cell.per.Trip, Year,Area, Site, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude,meannpp, meanorbv, meansst, meanmaxsst, meanwh)%>%
  summarize(cpue=sum(cpue))

cpuecc<-cpuematch1%>%
  group_by(Area, Site, Year, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude,meannpp, meanorbv, meansst, meanmaxsst, meanwh)%>%
filter(Area=="Ano Nuevo" | Area=="Point Lobos" | Area=="Point Buchon" | Area=="Piedras Blancas")%>%
  filter(species!="Total")

cpuecc1y<-cpuecc%>%
  group_by(Year, Area, Site, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude)%>%
  summarize(meancpue=mean(cpue), secpue=std.error(cpue),
            lower = mean(cpue) - qt(1- alpha/2, (n() - 1))*sd(cpue)/sqrt(n()),
                       upper = mean(cpue) + qt(1- alpha/2, (n() - 1))*sd(cpue)/sqrt(n()),
            maxsst=mean(meanmaxsst), npp=mean(meannpp))


cpuecc2y<-cpuecc1y%>%
  select(Year, Area, Site, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude, maxsst, npp, species, meancpue)%>%
  spread(species, meancpue)

cpueccmetay<-cpuecc2y[,c(1:9)]
cpueccdatay<-cpuecc2y[,-c(1:9)]


#calculating fisher's alpha diversity, shannon diversity and simpson diversity
shan<-diversity(cpueccdatay, index="shannon")
simp<-diversity(cpueccdatay, index = "simpson")

#calcualte species richness
S <- specnumber(cpueccdatay)
#pielou's eveness
J <- shan/log(S)

#add richness and eveness to df
cpueccmetay$richness<-S
cpueccmetay$eveness<-J
cpueccmetay$shannon<-shan
cpueccmetay$simpson<-simp

cpueccmetay$Area<-factor(cpueccmetay$Area, levels=c( "Ano Nuevo", "Point Lobos", "Piedras Blancas", "Point Buchon"))


cpueccr<-cpueccmetay%>%
  group_by(Year, Site)%>%
  summarize(meanrich=mean(richness),  lowerrich = mean(richness) - qt(1- alpha/2, (n() - 1))*sd(richness)/sqrt(n()),
                       upperrich = mean(richness) + qt(1- alpha/2, (n() - 1))*sd(richness)/sqrt(n()), meanshan=mean(shannon),  lowershan = mean(shannon) - qt(1- alpha/2, (n() - 1))*sd(shannon)/sqrt(n()),
                       uppershan = mean(shannon) + qt(1- alpha/2, (n() - 1))*sd(shannon)/sqrt(n()),
            meaneven=mean(eveness),  lowereven = mean(eveness) - qt(1- alpha/2, (n() - 1))*sd(eveness)/sqrt(n()),
                       uppereven = mean(eveness) + qt(1- alpha/2, (n() - 1))*sd(eveness)/sqrt(n()))



 ccrich<- ggplot(cpueccr, aes(Year, meanrich, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    geom_line(aes(color=Site))+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Species richness")+
  geom_errorbar(aes(ymax=upperrich, ymin=lowerrich), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

 ccshan<-ggplot(cpueccr, aes(Year, meanshan, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    geom_line(aes(color=Site))+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Shannon-Wiener diversity")+
   ylim(1, 2.25)+
  geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
  
 cceven<-ggplot(cpueccr, aes(Year, meaneven, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    geom_line(aes(color=Site))+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Pielou's evenness")+
  geom_errorbar(aes(ymax=uppereven, ymin=lowereven), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
  
pl<-plot_grid(ccrich, cceven, ccshan, ncol=1) 

cpueccmetay<-cpueccmetay%>%
  mutate(mhw=ifelse(Year < 2014, "Before",
               ifelse(Year > 2016 , "After", "During")))
cpueccmetay$mhw<-factor(cpueccmetay$mhw, levels=c("Before", "During", "After"))

#ANCOVA between site and year
cpueccS<-cpueccmetay%>%
  group_by(mhw)%>%
  anova_test(shannon~Year*Site)

r1<-aov(richness~mhw*Site, data=cpueccmetay)
summary(r1)
TukeyHSD(r1)

cpueccR<-cpueccmetay%>%
  group_by(mhw)%>%
  anova_test(richness~Year*Site)


cpueccE<-cpueccmetay%>%
  group_by(mhw)%>%
  anova_test(eveness~Year* Site)


##project slopes out past data 
library(broom)
cpueccrafter<-cpueccmetay%>%
  filter(Year>2016)
cpueccrafter$mhwYear<-(cpueccrafter$Year-2016)
caMPA<-cpueccrafter%>%
  filter(Site=="MPA")
Ampa<-lm(shannon~mhwYear, data=caMPA)
summary(Ampa)

mpaA<-augment(Ampa, caMPA)
var_year<-data.frame(mhwYear=c(1:20))
mod1<-predict.lm(Ampa, newdata=var_year)

caREF<-cpueccrafter%>%
  filter(Site=="REF")
Aref<-lm(shannon~mhwYear, data=caREF)
summary(Aref)
mod2<-predict.lm(Aref, newdata=var_year)

cpueccrX<-cpueccr%>%
  filter(Year>2016)

cpueccrX$mhwYear<-(cpueccrX$Year-2016)

ggplot(cpueccrX, aes(mhwYear, meanshan,  fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
  xlim(1,20)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  stat_smooth(method='lm', formula=y~x, se=F, aes(color=Site), fullrange=TRUE)+
  ylab("Shannon weiner diveristy")+
  xlab("Years post MHW")+
  geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
  
mod1<-as.data.frame(mod1)
mod2<-as.data.frame(mod2)
mod1$mhwYear<-c(1:20)
mod2$mhwYear<-c(1:20)
predDiv<-full_join(mod1,mod2, by="mhwYear")
predDiv<-predDiv%>%
  rename(MPA=mod1, REF=mod2)
predDiv<-predDiv%>%
  gather(Site, shannon, -mhwYear)

#ggplot(cpueccrX, aes(mhwYear, meanshan,  fill=Site, shape=Site))+
# geom_point(size=2, position=position_dodge(0.2))+
ggplot(predDiv, aes(mhwYear,shannon,  fill=Site, shape=Site))+
  geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
  xlim(1,20)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  stat_smooth(method='lm', formula=y~x, aes(color=Site), fullrange=TRUE)+
  ylab("Shannon weiner diveristy")+
  xlab("Years post MHW")+
 # geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

 
#Plot Diversity metrics by Year faceted by site
ggplot(cpueccmetay, aes(Year, shannon))+
  geom_point(aes(shape=Site, fill=Site), size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
  scale_fill_manual(values=c("#b2182b", "#2166ac"))+
  facet_wrap(~Area)+
  ylab("Shannon-Weiner diveristy index")+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

ggplot(cpueccmetay, aes(Year, eveness))+
  geom_point(aes(shape=Site, fill=Site), size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
  geom_line(aes(color=Site))+
  scale_fill_manual(values=c("#b2182b", "#2166ac"))+
  facet_wrap(~Area)+
  ylab("Pielou's eveness")+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

cpueccmetay<-cpueccmetay%>%
  mutate(mhw= ifelse(Year < 2014, "Before",
               ifelse(Year > 2016 , "After", "During")))
cpueccmetay$mhw<-factor(cpueccmetay$mhw, levels=c("Before", "During", "After"))

mhwdiv<-cpueccmetay%>%
  group_by(mhw, Site)%>%
  summarize(mshan=mean(shannon), seshan=std.error(shannon), mrich=mean(richness), serich=std.error(richness), meven=mean(eveness), seeven=std.error(eveness))
cpueccmetay$Year.1<-as.factor(cpueccmetay$Year)

#Run simple 2 way interactive anovas for each diversity metric in relation to MHW and Site (MPA vs REF)
summary(aov(shannon~mhw*Site,data = cpueccmetay))
TukeyHSD(aov(shannon~mhw*Site,data = cpueccmetay))

summary(aov(richness~mhw*Site,data = cpueccmetay))
TukeyHSD(aov(richness~mhw*Site,data = cpueccmetay))

summary(aov(eveness~mhw*Site,data = cpueccmetay))
TukeyHSD(aov(eveness~mhw*Site,data = cpueccmetay))

shan<-ggplot(mhwdiv, aes(mhw, mshan, fill=Site))+
  geom_bar(stat="identity", color="black", position=position_dodge(0.9))+
  geom_errorbar(aes(ymax=mshan+seshan, ymin=mshan-seshan), position=position_dodge(0.9), width=0.1)+
  scale_fill_manual(values=c("#b2182b", "#2166ac"))+
   ylab("Shannon-Weiner diveristy index")+
  xlab("")+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
  ggtitle("")+
  theme(legend.position="none")


rich<-ggplot(mhwdiv, aes(mhw, mrich, fill=Site))+
  geom_bar(stat="identity", color="black", position=position_dodge(0.9))+
  geom_errorbar(aes(ymax=mrich+serich, ymin=mrich-serich), position=position_dodge(0.9), width=0.1)+
  scale_fill_manual(values=c("#b2182b", "#2166ac"))+
   ylab("Species richness")+
  xlab("")+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
    ggtitle("")+
  theme(legend.position="none")


even<-ggplot(mhwdiv, aes(mhw, meven, fill=Site))+
  geom_bar(stat="identity", color="black", position=position_dodge(0.9))+
  geom_errorbar(aes(ymax=meven+seeven, ymin=meven-seeven), position=position_dodge(0.9), width=0.1)+
  scale_fill_manual(values=c("#b2182b", "#2166ac"))+
   ylab("Pielou's evenness")+
  xlab("")+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
  ggtitle("")+
  theme(legend.position="none")
  
plot_grid(rich, even, shan, ncol=1)


```


```{r}
###There is a 2 - year lag with MOCI on diversity...
cpueccr1<-left_join(cpueccr, moci)

mshan2<-ggplot(cpueccr1, aes(lag(MOCI,4), meanshan, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    #geom_line(aes(color=Site))+
    geom_smooth(method='lm', aes(color=Site), se=F)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Shannon Diversity")+
  xlab("Multivariate Oceanographic Climate Indicator (MOCI)")+
  #ggtitle("Two year lag")+
 # ggtitle("Relationship between fish diveristy and MOCI with a 2 year lag")+
  #geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

mshan3<-ggplot(cpueccr1, aes(lag(MOCI,6), meanshan, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    #geom_line(aes(color=Site))+
    geom_smooth(method='lm', aes(color=Site), se=F)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Shannon Diversity")+
  xlab("")+
  ggtitle("Three year lag")+
 # ggtitle("Relationship between fish diveristy and MOCI with a 2 year lag")+
  #geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

mshan1<-ggplot(cpueccr1, aes(lag(MOCI,2), meanshan, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    #geom_line(aes(color=Site))+
    geom_smooth(method='lm', aes(color=Site), se=F)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Shannon Diversity")+
  xlab("")+
  ggtitle("One year lag")+
 # ggtitle("Relationship between fish diveristy and MOCI with a 2 year lag")+
  #geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

plot_grid(mshan1, mshan2, mshan3, ncol=3)

mrich<-ggplot(cpueccr1, aes(lag(MOCI,4), meanrich, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    #geom_line(aes(color=Site))+
    geom_smooth(method='lm', aes(color=Site), se=F)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Species Richness")+
  xlab("Multivariate Oceanographic Climate Indicator (MOCI)")+
 # ggtitle("Relationship between fish diveristy and MOCI with a 2 year lag")+
  #geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

meven<-ggplot(cpueccr1, aes(lag(MOCI,4), meaneven, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    #geom_line(aes(color=Site))+
    geom_smooth(method='lm', aes(color=Site), se=F)+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Evenness")+
  xlab("Multivariate Oceanographic Climate Indicator (MOCI)")+
 # ggtitle("Relationship between fish diveristy and MOCI with a 2 year lag")+
  #geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

title <- ggdraw() + 
  draw_label(
    "Two year lag",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
pl1<-plot_grid(mrich, meven, mshan2, ncol=1)
plot_grid(pl, pl1, ncol=2)

plot_grid(title, pl1, ncol=1, rel_heights = c(0.1, 1))

cpueccX<-cpueccr1%>%
  group_by(Site)%>%
  anova_test(meanshan~lag(MOCI,4))

anova(lm(meanshan~lag(MOCI,4)*Site, data=cpueccr1))
anova(lm(meanrich~lag(MOCI,2)*Site, data=cpueccr1 ))
anova(lm(meanrich~lag(MOCI,4)*Site, data=cpueccr1 ))
summary(lm(meanrich~lag(MOCI,6)*Site, data=cpueccr1 ))
anova(lm(meaneven~lag(MOCI,4)*Site, data=cpueccr1))
```


NMDS - Community Composition 

```{r}
bpue<-read.csv('2020-Raw_Data/BPUE.per.IDcell_2020.csv')
mpadata<-read.csv('2020-Raw_Data/mpa-data-2.csv')
enviro<-read.csv('2020-Raw_Data/sumenvironmentaldata.csv')
enviro<-enviro%>%
  rename(Site=MPA_Status)
traits<-read.csv("2020-Raw_Data/CCFRP-FishTraits.csv")


#Gather data into long format
bpue<-bpue%>%
  group_by(Area, Site, Year)%>%
  gather(species, bpue,-ID.Cell.per.Trip,  -Area, -Site, -Year, -Total.Angler.Hours, -Grid.Cell.ID)



#Combine Blue and Deacon Rockfish into one complex
bpue$species <- recode_factor(bpue$species, Blue.Rockfish = "Blue.Deacon.Rockfish", 
                                Deacon.Rockfish = "Blue.Deacon.Rockfish")

#Match the MPA information to CPUE data. 
bpuematch<-inner_join(bpue, mpainfo, by = 'Area')

#Combine CPUE/MPA infro with environmental data and sum the BPUE for each species within a grid cell. 
bpuematch1<-left_join(bpuematch, enviro, by = c("Area", "Site", "Year"))%>%
  group_by(ID.Cell.per.Trip, Year,Area, Site, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude,meannpp, meanorbv, meansst, meanmaxsst, meanwh)%>%
  summarize(bpue=sum(bpue))
```

Examine changes in diveristy through time for CC data. Examine before during and after the marine heatwave. Then run NMDS to determine shifts in community structure.

```{r}
#Filter out Central Coast sites and remove Total (all fished BPUE combined)
bpuecc<-bpuematch1%>%
group_by(Area, Site, Year, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude,meannpp, meanorbv, meansst, meanmaxsst, meanwh)%>%
filter(Area=="Ano Nuevo" | Area=="Point Lobos" | Area=="Point Buchon" | Area=="Piedras Blancas")%>%
  filter(species!="Total")

#Join filtered data with species trait table
bpueccm<-left_join(bpuecc, traits, by="species")%>%
  filter(Central.Region=="TRUE")
  
#Create mhw column with years binned by Before (2007-2013), During (2014-2016) and After (2017-2020) the marine heatwave 
bpueccm<-bpueccm%>%
  mutate(mhw= ifelse(Year < 2014, "Before",
               ifelse(Year > 2016 , "After", "During")))

#Reorder mhw factors to before during and after rather than alphabetical order
bpueccm$mhw<-factor(bpueccm$mhw, levels=c("Before", "During", "After"))

#Calculate mean bpue and environmental data for each year and species.
bpuecc1<-bpueccm%>%
  group_by(Year, mhw, Area, Site, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude, Family, TrophicGroup, Fished, water_column_position, mobility)%>%
  summarize(meanbpue=mean(bpue), sebpue=std.error(bpue),
            lower = mean(bpue) - qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()),
                       upper = mean(bpue) + qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()),
            maxsst=mean(meanmaxsst), npp=mean(meannpp))

#Calculate mean bpue by year, site and species name.
bpueccstacked<-bpueccm%>%
  group_by(Year, mhw, Site, Name)%>%
  summarize(meanbpue=mean(bpue), sebpue=std.error(bpue),
            lower = mean(bpue) - qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()),
                       upper = mean(bpue) + qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()))%>%
  na.omit()

#Combine species that are not the top ten most abundant to an other category 
bpueccstacked1<-bpueccm%>%
  group_by(Year, mhw, Site, Name, ID.Cell.per.Trip)%>%
   mutate(Name= ifelse(Name=="Black Rockfish", "Black Rockfish",
                          ifelse(Name=="Blue/Deacon Rockfish", "Blue/Deacon Rockfish",
                                 ifelse(Name=="Gopher Rockfish", "Gopher Rockfish",
                                        ifelse(Name=="Copper Rockfish", "Copper Rockfish",
                                               ifelse(Name=="Canary Rockfish", "Canary Rockfish",
                                                      ifelse(Name=="Olive Rockfish", "Olive Rockfish",
                                                             ifelse(Name=="Vermilion Rockfish", "Vermilion Rockfish",
                                                                    ifelse(Name=="Yellowtail Rockfish", "Yellowtail Rockfish",
                                                                           ifelse(Name=="Lingcod", "Lingcod",
                                                                                  ifelse(Name=="Kelp Rockfish", "Kelp Rockfish"  ,"Other")))))))))))%>%
  summarize(bpue=sum(bpue))%>%
  group_by(Year, mhw, Site, Name)%>%
  summarize(meanbpue=mean(bpue), sebpue=std.error(bpue),
            lower = mean(bpue) - qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()),
                       upper = mean(bpue) + qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()))%>%
  na.omit()


stacked<-bpueccstacked1%>%
  group_by(mhw, Site, Name)%>%
  summarize(bpue=sum(meanbpue))

stacked$Name<-factor(stacked$Name, levels=c("Black Rockfish", "Blue/Deacon Rockfish", "Canary Rockfish", "Copper Rockfish", "Gopher Rockfish", "Kelp Rockfish", "Lingcod", "Olive Rockfish", "Vermilion Rockfish", "Yellowtail Rockfish", "Other"))

#stacked[complete.cases(stacked)]

stacked1<-bpueccstacked1%>%
  group_by(mhw, Site)%>%
  summarize(totalbpue=sum(meanbpue))

stacked<-left_join(stacked, stacked1, by=c("mhw", "Site"))

sp1<-ggplot(stacked, aes(x=mhw, y=(bpue/totalbpue)))+
  geom_bar(stat="identity", aes(fill=Name), color="black")+
    theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
  guides(fill=guide_legend(title="Species"))+
    ylab("Proportion of Total Community")+
    xlab("")+
  facet_wrap(~Site)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  guides(fill=guide_legend(ncol=1))


#trophic group
bpueccstackedtg<-bpueccm%>%
filter(TrophicGroup=="macro-invertivore" |TrophicGroup=="micro-invertivore" | TrophicGroup=="piscivore" | TrophicGroup=="piscivore/invertivore" |TrophicGroup=="planktivore")

bpueccstackedtg$TrophicGroup <- recode_factor(bpueccstackedtg$TrophicGroup, 
                                              `macro-invertivore` = "invertivore",
                                              `micro-invertivore` = "invertivore", 
                                              `piscivore/invertivore` = "mixed carnivore")

bpueccstackedtg<-bpueccstackedtg%>%
  group_by(Year, Site, mhw, TrophicGroup)%>%
  summarize(meanbpue=mean(bpue), sebpue=std.error(bpue),
            lower = mean(bpue) - qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()),
                       upper = mean(bpue) + qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()))

stackedtg<-bpueccstackedtg%>%
  #filter(Year>2017)%>%
  group_by(Site, mhw, TrophicGroup)%>%
  summarize(bpue=sum(meanbpue))

#stackedtg[complete.cases(stackedtg)]

stackedtg1<-bpueccstackedtg%>%
  #filter(Year>2017)%>%
  group_by(Site, mhw)%>%
  summarize(totalbpue=sum(meanbpue))

stackedtg<-left_join(stackedtg, stackedtg1, by=c("mhw", "Site"))
stackedtg$TrophicGroup<-factor(stackedtg$TrophicGroup, levels=c("piscivore", "mixed carnivore", "invertivore", 
                                                                "planktivore"))
stackedtg$percent<-(stackedtg$bpue/stackedtg$totalbpue)

tg<-ggplot(stackedtg, aes(x=mhw, y=(bpue/totalbpue)))+
  geom_bar(stat="identity", aes(fill=TrophicGroup), color="black")+
    theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
  guides(fill=guide_legend(title="Trophic Group"))+
  facet_wrap(~Site)+
    ylab("Proportion of Total Community")+
    xlab("")+
   scale_fill_viridis_d()


plot_grid(sp1, tg, rel_widths = c(1,0.9))
```

Create SPP matrix
```{r}
#Species
bpuecc2<-bpuecc1%>%
  select(Year, mhw, Area, Site, species, meanbpue)

bpuecc2<-bpuecc2[,-c(1:8)]
bpuecc2<-bpuecc2%>%
  spread(species, meanbpue)

bpueccmeta<-bpuecc2[,c(1:4)]


moci<-read.csv("Raw_Data /CA-MOCI.csv")

moci<- moci%>%
  filter(Season=="JAS")%>%
  filter(Year>2004)%>%
  select(Year, Central.California..34.5.38N.)%>%
  rename(MOCI=Central.California..34.5.38N.)%>%
  rename(Year.1=Year)

moci$Year<-moci$Year.1+2

env<-read.csv("Raw_Data /sumenviroCC1.csv")

envall<-left_join(moci, env, by="Year")%>%
  rename(Site=MPA_Status)

envall<-envall%>%
  select(Year,Area, Site, MOCI,meansst, meanmaxsst, meannpp, meanwh, meanws, meanorbv)

bpueccmeta<-left_join(bpueccmeta, envall, by=c("Year", "Area", "Site"))

bpueccdata<-bpuecc2[,-c(1:4)]

#Add a column of 1s to ensure there are no rows with all 0s (does not change the similarity between rows)
bpueccdata$add<-1

#Remove blues if we want to
bpueccdata1<-bpueccdata[,-7]
#create bray curtis distribution
set.seed(22)

abund.distcc <- vegdist(bpueccdata, method = "bray")
attach(bpueccmeta) 

#Run PERMANOVA
#Examine MPA by site by year
adonis(abund.distcc~Site*mhw)



#Trophic group
bpuecctg<-bpueccm

bpuecctg<-bpuecctg%>%
  filter(TrophicGroup=="macro-invertivore" |TrophicGroup=="micro-invertivore" | TrophicGroup=="piscivore" | TrophicGroup=="piscivore/invertivore" |TrophicGroup=="planktivore")

bpuecctg$TrophicGroup <- recode_factor(bpuecctg$TrophicGroup, 
                                              `macro-invertivore` = "invertivore",
                                              `micro-invertivore` = "invertivore", 
                                              `piscivore/invertivore` = "mixed carnivore")

bpuecctg<-bpuecctg%>%
  group_by(Year, mhw, Area, Site, TrophicGroup)%>%
  summarize(meanbpue=mean(bpue))

bpuecctgs<-bpuecctg%>%
  group_by(Year, mhw, Area, Site)%>%
  spread(TrophicGroup, meanbpue)

bpuecctgd<-bpuecctgs[,-c(1:4)]
bpuecctgm<-bpuecctgs[,c(1:4)]

abund.distTG <- vegdist(bpuecctgd, method = "bray")
attach(bpuecctgm) 

adonis(abund.distTG~Site*mhw)
```

Run NMDS 

```{r, warning=FALSE}
set.seed(22)

#try NMDS 
prac_NMDScc=metaMDS(abund.distcc,k=2,trymax=5000)


nmds.envfitcc <- envfit(prac_NMDScc, bpueccmeta, permutations = 999, na.rm=T)
spp.fitcc <- envfit(prac_NMDScc, bpueccdata, permutations = 999)

#stress is 0.188
stressplot(prac_NMDScc)
 
#group treatment 
plot(prac_NMDScc)

# you can use ordiellipse but have to identify treatment group - I usually wait until I plot in ggplot because it will do the ellipse around whatever you use the fill or color command

ordiellipse(prac_NMDScc,groups=mhw,draw="polygon",col="grey90",label=F)
#ordiplot(prac_NMDS,type="n")
orditorp(prac_NMDScc, display="species",col="red",air=0.01)


#group treatment 
plot(prac_NMDScc)

# you can use ordiellipse but have to identify treatment group - I usually wait until I plot in ggplot because it will do the ellipse around whatever you use the fill or color command

ordiellipse(prac_NMDScc,groups=mhw,draw="polygon",col="grey90",label=F)


#switch the ordination axes to be more similar to a PCA where axis 1 explains the most variation. 
nms2cc<-princomp(prac_NMDScc$points) 
print(nms2cc)


#Save the plot scores form the nmds into a sheet
plot.scorescc<-nms2cc$scores # plot scores

#rename the columns in your the plot.scores df
colnames(plot.scorescc) <- c("NMS1", "NMS2")

#Save the species.score from NMDS
fish.wacc <- wascores(plot.scorescc,bpueccdata)

#make plot.scores sheet into df for plotting
plot.scorescc.df<-data.frame(plot.scorescc)


spp.scrscc <- as.data.frame(scores(spp.fitcc, display = "vectors")) #save species intrinsic values into dataframe
spp.scrscc <- cbind(spp.scrscc, Species = rownames(spp.scrscc)) #add species names to dataframe
spp.scrscc <- cbind(spp.scrscc, pval = spp.fitcc$vectors$pvals) #add pvalues to dataframe so you can select species which are significant
#spp.scrs<- cbind(spp.scrs, abrev = abbreviate(spp.scrs$Species, minlength = 6)) #abbreviate species names
sig.spp.scrscc <- subset(spp.scrscc, pval<=0.001) #subset data to show species significant at 0.05
sig.spp.scrscc<-sig.spp.scrscc%>%
  rename(NMS1=NMDS1, NMS2=NMDS2)

env.scrscc<- as.data.frame(scores(nmds.envfitcc, display = "vectors"))
env.scrscc <- cbind(env.scrscc, Variables = rownames(env.scrscc)) #add species names to dataframe
env.scrscc <- cbind(env.scrscc, pval = nmds.envfitcc$vectors$pvals)
sig.env.scrscc<-env.scrscc%>%
  filter(pval<0.05)%>%
  rename(NMS1=NMDS1, NMS2=NMDS2)


#merge the plot scores df with the ROV information df so the nms scores correspond to each row of data 
nmsdfcc<-merge(plot.scorescc.df, bpueccmeta, by="row.names")

#plot NMDS with ggplot - here I am examining the community composition for all MPAs sampled by yera. The stat_ellispe is providing the 95% CI around the data. 
#nmsdf$Year<-factor(nmsdf$Year)
nmsdfcc$Area<-factor(nmsdfcc$Area, levels=c("Ano Nuevo","Point Lobos","Piedras Blancas" ,'Point Buchon'))


nspp<-ggplot(nmsdfcc, aes(x=NMS1, y=NMS2))+
  geom_point(size=2, alpha=0.2,aes(fill=mhw, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#2166ac", "#b2182b","#fddbc7"))+
  scale_color_manual(values=c("#2166ac","#b2182b","#fddbc7"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, size=1.1, aes(linetype=Site, color=mhw))+
    #ggtitle("Community shifts with the marine heatwave")+ 
  geom_segment(data = sig.spp.scrscc, aes(x = 0, xend=NMS1, y=0, yend=NMS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.3) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = sig.spp.scrscc, aes(x=NMS1, y=NMS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
   theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
   guides(fill=guide_legend(override.aes=list(shape=21)))+
    ylim(-0.9, 0.5)+
  xlim(-0.5,1)



#By Site
nenv<-ggplot(nmsdfcc, aes(x=NMS1, y=NMS2))+
  geom_point(size=2, alpha=0.2,aes(fill=mhw, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#2166ac","#b2182b","#fddbc7"))+
  scale_color_manual(values=c("#2166ac","#b2182b","#fddbc7"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
   stat_ellipse(level=0.95, size=1.1, aes(linetype=Site, color=mhw))+
  # ggtitle("Community Composition MPA Group")+
   geom_segment(data = sig.env.scrscc, aes(x=0, xend=NMS1, y=0, yend=NMS2),arrow = arrow(length = unit(0.25, "cm")), colour = "grey50", lwd=0.5)+ #add vector arrows of significant species
  ggrepel::geom_text_repel(data = sig.env.scrscc, aes(x=NMS1, y=NMS2, label = Variables), cex = 4, direction = "both", segment.size = 0, max.overlaps=30)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
    ylim(-0.9, 0.5)+
  xlim(-0.5,1)


plot_grid(nspp, nenv, labels = c("A", "B"))

#Simper anlaysis - this analysis tells you what species are driving the dissimilarity between groups - here it will tell you for a year comparision the to species driving variation -

#This is the cummulative contribution - so the 1st species is the most important (the greatest contribution) and the 2nd (combined 1+2 contribution) and so on...

(biomsim<-with(bpueccmeta, simper(bpueccdata, mhw)))


#(biomsim<-with(bpueccmeta, simper(bpueccdata, Site)))
summary(biomsim)


```


Plot slopes of bpue before and after heatwave

```{r}
bpuespp<-bpuematch%>%
  group_by(ID.Cell.per.Trip, Area, Site, Year, species)%>%
  filter(species != "Total" & species != "UnID.Blue.Rockfish" & species != "Unknown" & species != "Unknown.rockfish" & species != "Chinook.Salmon" & species != "Mackerel..Family.Scombridae." & species != "Olive.or.Yellowtail.Rockfish")%>%
  filter(Area=="Ano Nuevo"| Area=="Point Lobos"| 
           Area=="Piedras Blancas" | Area == 'Point Buchon')%>%
  summarize(bpue=sum(bpue))%>%
    group_by(Area, Site, Year, species)%>%
  summarize(meanbpue=mean(bpue))

#bpuespp$Area<-factor(bpuespp$Area, levels=c("Ano Nuevo", "Point Lobos", "Piedras Blancas", "Point Buchon"))

bpuespp<-bpuespp%>%
  filter(meanbpue>0)

bpuespp1<-bpuespp%>%
  group_by(Year, Site)%>%
  spread(species, meanbpue)
bpuespp1[is.na(bpuespp1)]<-0


#write.csv(bpuespp1, "BPUECCFRPReponseRateData.csv")
#bpuespp1<-read.csv("BPUECCFRPReponseRateData.csv")

bpuespp2<-bpuespp1%>%
  gather(Species, meanbpue, -Year, -Site, -Area)%>%
 filter(Species == "Vermilion.Rockfish" | Species == "Copper.Rockfish" | Species == "Starry.Rockfish" | Species == "Canary.Rockfish" | Species == "Gopher.Rockfish" | Species == "Brown.Rockfish" | Species == "Ocean.Whitefish" | Species == "Kelp.Greenling" | Species == "Lingcod" | Species == "Olive.Rockfish" | Species == "Kelp.Rockfish" | Species == "Blue.Deacon.Rockfish" | Species == "Yellowtail.Rockfish" | Species == "Rosy.Rockfish" | Species == "Calico.Rockfish" | Species == "Black.Rockfish" | Species == "China.Rockfish" | Species == "Black.and.Yellow.Rockfish" | Species == "Treefish" | Species == "Pacific...Chub..Mackerel" | Species == "Cabezon")

bpuespp2$timeimp<-(bpuespp2$Year-2007)
#bpuespp1<-read.csv("CCFRPReponseRateData.csv")

#bpuespp2<-bpuespp1%>%
#  gather(Species, meanbpue, -Year, -Site, -Area)

#bpuespp2$timeimp<-(bpuespp2$Year-2007)

#ggplot(bpuespp, aes(Year, meanbpue, color=Site, shape=species))+
#  geom_point()+
#  geom_smooth(method="lm")

#Combined  -scale it. 
bpuesppMPA<-bpuespp2%>%
  filter(Site=="MPA")


bpuespp2<-bpuespp2%>%
  mutate(mhw= ifelse(Year < 2014, "Before",
               ifelse(Year > 2016 , "After", "During")))

bpuespp2$mhw<-factor(bpuespp2$mhw, levels=c("Before", "During", "After"))

bpuesppmean<-bpuespp2%>%
  group_by(Species, Year, Site, mhw)%>%
  summarize(mbpue=mean(meanbpue), lower = mean(meanbpue) - qt(1- alpha/2, (n() - 1))*sd(meanbpue)/sqrt(n()),
                       upper = mean(meanbpue) + qt(1- alpha/2, (n() - 1))*sd(meanbpue)/sqrt(n()))

ggplot(bpuesppmean, aes(Year, mbpue, fill=Species))+
 geom_point(shape=21)+
  #facet_wrap(~Site)+
 geom_smooth(aes(color=Species), se=F)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(y=expression(BPUE~(kg~angler~hr^{-2})))+
 # coord_cartesian(ylim=c(0,5))+
  geom_errorbar(aes(ymax=upper, ymin=lower), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
  guides(fill=guide_legend(ncol=1))+
  facet_grid(Site~mhw, scale="free_x")+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  scale_x_continuous(breaks=c(2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021))

Mbpuespp<-left_join(bpuesppmean, moci)

ggplot(Mbpuespp, aes(MOCI, mbpue, fill=Species))+
 geom_point(size=3, aes(shape=mhw))+
  scale_shape_manual(values=c(21,22,23))+
  #facet_wrap(~Site)+
 geom_smooth(aes(color=Species), se=F)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(y=expression(BPUE~(kg~angler~hr^{-2})))+
 # coord_cartesian(ylim=c(0,5))+
  geom_errorbar(aes(ymax=upper, ymin=lower), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+
  guides(fill=guide_legend(ncol=1))+
  facet_wrap(~Site, scale="free_x")+
  theme(axis.text.x = element_text(angle = 45, hjust=1))


bpuespp10<-bpuesppmean%>%
  filter(Species=="Black.Rockfish" | Species=="Blue.Deacon.Rockfish" | Species=="Gopher.Rockfish"| Species=="Copper.Rockfish"|Species=="Lingcod"| Species=="Canary.Rockfish"| Species=="Olive.Rockfish" |Species=="Vermilion.Rockfish" | Species=="Yellowtail.Rockfish" | Species=="Kelp.Rockfish")
  
ggplot(bpuespp10, aes(x=Year, y=mbpue, fill=Site)) + 
  geom_point(shape=21,size=3)+
  geom_line(aes(color=Site))+
  scale_fill_manual(values=c("#b2182b", "#2166ac"), "Site")+
  #geom_smooth(method='lm', se=FALSE, aes(color=Site))+
  scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab('BPUE')+
  geom_errorbar(aes(ymax=upper, ymin=lower),  width=0)+
  labs(y=expression(BPUE~(kg~angler~hr^{-1})))+
  #ggtitle("BPUE - Central Coast")+
  facet_wrap(~Species, scales="free_y", ncol=5)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

  
ancovaCspp<-bpueC%>%
  group_by(species)%>%
  anova_test(bpue ~ Site*Year)

avgbpueC<-bpueC%>%
  group_by(Site, Year, species)%>%
  summarize(meanbpue=mean(bpue), sebpue=std.error(bpue),
            lower = mean(bpue) - qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()),
                     upper = mean(bpue) + qt(1- alpha/2, (n() - 1))*sd(bpue)/sqrt(n()))

ggplot(avgbpueC, aes(x=Year, y=meanbpue, fill=Site)) + 
  geom_point(shape=21,size=3)+
  geom_line(aes(color=Site))+
  scale_fill_manual(values=c("#b2182b", "#2166ac"), "Site")+
  #geom_smooth(method='lm', se=FALSE, aes(color=Site))+
  scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab('BPUE')+
  geom_errorbar(aes(ymax=upper, ymin=lower),  width=0)+
  labs(y=expression(BPUE~(kg~angler~hr^{-1})))+
  #ggtitle("BPUE - Central Coast")+
  facet_wrap(~species, scales="free_y", ncol=5)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))





bpuesppA<-bpuespp2%>%
  filter(Year>=2016)
bpuesppB<-bpuespp2%>%
  filter(Year<=2014)

#Filter MPA before
bpuempaB<-bpuesppB%>%
  filter(Site=="MPA")

bpuerefB<-bpuesppB%>%
  filter(Site=="REF")

#Filter MPA after
bpuempaA<-bpuesppA%>%
  filter(Site=="MPA")

bpuerefA<-bpuesppA%>%
  filter(Site=="REF")
#Run serial linear models - for bpue by year. 
#For loop. 

library(nlme)
mpamodB<-lmList(meanbpue ~ timeimp | Species, data=bpuempaB)
mpa1B<-bind_rows(coef(mpamodB))

refmodB<-lmList(meanbpue ~ timeimp | Species, data=bpuerefB)
ref1B<-bind_rows(coef(refmodB))


mpamodA<-lmList(meanbpue ~ timeimp | Species, data=bpuempaA)
mpa1A<-bind_rows(coef(mpamodA))

refmodA<-lmList(meanbpue ~ timeimp | Species, data=bpuerefA)
ref1A<-bind_rows(coef(refmodA))
  
mpa1B<-rownames_to_column(mpa1B)
ref1B<-rownames_to_column(ref1B)
mpa1A<-rownames_to_column(mpa1A)
ref1A<-rownames_to_column(ref1A)

modoutputB<-left_join(mpa1B, ref1B, by=c("rowname"))
modoutputA<-left_join(mpa1A, ref1A, by=c("rowname"))
#write.csv(modoutputB, "CCFRP-LinearModelOutput-bpue.csv")

modoutputB<-modoutputB%>%
  rename(MPA=timeimp.x, REF=timeimp.y)
modoutputA<-modoutputA%>%
  rename(MPA=timeimp.x, REF=timeimp.y)



par(mfrow=c(2,2))

hist(modoutputB$MPA, breaks=5, col="#b2182b", xlab="Rate of Change in BPUE over Time", xlim=c(-0.4,0.8),ylim=c(0,20), main="MPA Before Heatwave")
abline(v=0,lwd=4, lty=2, col='gray80')

hist(modoutputB$REF, breaks=5, col="#2166ac", xlab="Rate of Change in BPUE over Times", xlim=c(-0.4,0.8),ylim=c(0,20), main="REF Before Heatwave")
abline(v=0,lwd=4, lty=2, col='gray80')

hist(modoutputA$MPA, breaks=20, col="#b2182b", xlab="Rate of Change in BPUE over Time", xlim=c(-0.4,0.8),ylim=c(0,20), main="MPA After Heatwave")
abline(v=0,lwd=4, lty=2, col='gray80')

hist(modoutputA$REF, breaks=5, col="#2166ac", xlab="Rate of Change in BPUE over Time", xlim=c(-0.4,0.8),ylim=c(0,20), main="REF After Heatwave")
abline(v=0,lwd=4, lty=2, col='gray80')

par(mfrow=c(1,1))

ks.test(modoutputA$MPA, modoutputB$MPA)

ks.test(modoutputA$REF, modoutputB$REF)
```


Rerun Central Coast analysis without Blue/Deacon rockfish complex

```{r}
#Add a column of 1s to ensure there are no rows with all 0s (does not change the similarity between rows)
bpuecc2br<-bpuecc1%>%
  select(Year, mhw, Area, Site, species, meanbpue)

bpuecc2br<-bpuecc2br[,-c(1:8)]
bpuecc2br<-bpuecc2br%>%
  filter(species!="Blue.Deacon.Rockfish")%>%
  spread(species, meanbpue)

bpueccdatay<-bpuecc2br[,-c(1:4)]
bpueccmetay<-bpuecc2br[,c(1:4)]


bpueccdatay$add<-1
#create bray curtis distribution
abund.dist1 <- vegdist(bpueccdatay, method = "bray")
attach(bpueccmetay) 

set.seed(22)
#Run PERMANOVA
#Examine Region by Site
#xx1<-adonis(abund.dist~Area*Site)
#library(pairwiseAdonis)
#pairwise.adonis2(abund.dist~Area*Site, data=bpueccmetay)


#Examine MPA by site by year
adonis(abund.dist1~Site*mhw)

```

Run NMDS without Blue Rockfish

```{r, warning=FALSE}
set.seed(22)

#try NMDS 
prac_NMDS=metaMDS(abund.dist1,k=2,trymax=1000)

envfit(prac_NMDS, bpueccdatay)
nmds.envfit <- envfit(prac_NMDS, bpueccmetay, permutations = 999)
spp.fit <- envfit(prac_NMDS, bpueccdatay, permutations = 999)

#stress is 0.159
prac_NMDS
stressplot(prac_NMDS)
 
#group treatment 
plot(prac_NMDS)

# you can use ordiellipse but have to identify treatment group - I usually wait until I plot in ggplot because it will do the ellipse around whatever you use the fill or color command

ordiellipse(prac_NMDS,groups=mhw,draw="polygon",col="grey90",label=F)
#ordiplot(prac_NMDS,type="n")
orditorp(prac_NMDS, display="species",col="red",air=0.01)

#switch the ordination axes to be more similar to a PCA where axis 1 explains the most variation. 
nms2<-princomp(prac_NMDS$points) 
print(nms2)


#Save the plot scores form the nmds into a sheet
plot.scores<-nms2$scores # plot scores

#rename the columns in your the plot.scores df
colnames(plot.scores) <- c("NMS1", "NMS2")

#Save the species.score from NMDS
fish.wa <- wascores(plot.scores,bpueccdatay)

#make plot.scores sheet into df for plotting
plot.scores.df<-data.frame(plot.scores)


spp.scrs <- as.data.frame(scores(spp.fit, display = "vectors")) #save species intrinsic values into dataframe
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs)) #add species names to dataframe
spp.scrs <- cbind(spp.scrs, pval = spp.fit$vectors$pvals) #add pvalues to dataframe so you can select species which are significant
#spp.scrs<- cbind(spp.scrs, abrev = abbreviate(spp.scrs$Species, minlength = 6)) #abbreviate species names
sig.spp.scrs <- subset(spp.scrs, pval<=0.001) #subset data to show species significant at 0.05
sig.spp.scrs<-sig.spp.scrs%>%
  rename(NMS1=NMDS1, NMS2=NMDS2)

env.scrs<- as.data.frame(scores(nmds.envfit, display = "vectors"))
env.scrs <- cbind(env.scrs, Variables = rownames(env.scrs)) #add species names to dataframe
env.scrs <- cbind(env.scrs, pval = nmds.envfit$vectors$pvals)
sig.env.scrs <- filter(env.scrs, Variables!="Cluster.Area_km2")
env.scrs<-env.scrs%>%
  rename(NMS1=NMDS1, NMS2=NMDS2)


#merge the plot scores df with the ROV information df so the nms scores correspond to each row of data 
nmsdf<-merge(plot.scores.df, bpueccmetay, by="row.names")

#plot NMDS with ggplot - here I am examining the community composition for all MPAs sampled by yera. The stat_ellispe is providing the 95% CI around the data. 
#nmsdf$Year<-factor(nmsdf$Year)
#nmsdf$Region<-factor(nmsdf$Region, levels=c("North", "Central", "South"))
nmsdf$Area<-factor(nmsdf$Area, levels=c("Ano Nuevo","Point Lobos","Piedras Blancas" ,'Point Buchon'))
nmsdf$Year1<-as.factor(nmsdf$Year)


#By year
ggplot(nmsdf, aes(x=NMS1, y=NMS2, shape=Site, fill=mhw, color=mhw))+
  geom_point(size=5, alpha=0.5)+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#b2182b","#fddbc7","#2166ac"))+
  scale_color_manual(values=c("#b2182b","#fddbc7","#2166ac"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, size=1.1, aes(linetype=Site))+
    ggtitle("MPA vs Reference")+ geom_segment(data = sig.spp.scrs, aes(x = 0, xend=NMS1, y=0, yend=NMS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.3)  #add vector arrows of significant species
#  ggrepel::geom_text_repel(data = sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)


#BY Region with species vectors 
ggplot(nmsdf, aes(x=NMS1, y=NMS2))+
  geom_point(size=3, alpha=0.6,aes(fill=Area, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#0571b0","#92c5de", "#f4a582", "#ca0020", "Area"))+
  scale_color_manual(values=c("#0571b0","#92c5de", "#f4a582", "#ca0020","Area"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, aes(color=Area), size=1.1)

#  geom_segment(data = sig.spp.scrs, aes(x=0, xend=NMS1, y=0, yend=NMS2), colour = "grey50", alpha=0.5, lwd=0.3)+ #add vector arrows of significant species
#  ggrepel::geom_text_repel(data = sig.spp.scrs, aes(x=NMS1, y=NMS2, label = Species), cex = 3.5, direction = "both", segment.size = 0.25, max.overlaps=25)+ 
#  theme_classic(base_size = 16)

ggplot(nmsdf, aes(x=NMS1, y=NMS2))+
  geom_point(size=3, alpha=0.6,aes(fill=Area, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#0571b0","#92c5de", "#f4a582", "#ca0020", "Area"))+
  scale_color_manual(values=c("#0571b0","#92c5de", "#f4a582", "#ca0020","Area"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, aes(color=Area), size=1.1)+
  geom_segment(data = env.scrs, aes(x=0, xend=NMS1, y=0, yend=NMS2), colour = "grey50", alpha=0.5, lwd=0.3)+ #add vector arrows of significant species
  ggrepel::geom_text_repel(data = env.scrs, aes(x=NMS1, y=NMS2, label = Variables), cex = 3.5, direction = "both", segment.size = 0.25, max.overlaps=25)+ 
  theme_classic(base_size = 16)



#Just vectors
ggplot(nmsdf, aes(x=NMS1, y=NMS2))+
  geom_segment(data = sig.spp.scrs, aes(x=0, xend=NMS1, y=0, yend=NMS2), colour = "grey50", alpha=0.5, lwd=0.3)+ #add vector arrows of significant species
  ggrepel::geom_text_repel(data = sig.spp.scrs, aes(x=NMS1, y=NMS2, label = Species), cex = 5, direction = "both", segment.size = 0.25, max.overlaps=25)+ 
  theme_classic(base_size = 16)


#BY Region with env vectors 
ggplot(nmsdf, aes(x=NMS1, y=NMS2))+
  geom_point(size=5, alpha=0.6,aes(fill=Region, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#2166ac","#fddbc7","#b2182b", "Region"))+
  scale_color_manual(values=c("#2166ac","#fddbc7","#b2182b","Region"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, aes(color=Region, linetype=Site), size=1.1)+
  geom_segment(data = sig.env.scrs, aes(x=0, xend=NMS1, y=0, yend=NMS2), colour = "grey50", lwd=0.5)+ #add vector arrows of significant species
  ggrepel::geom_text_repel(data = sig.env.scrs, aes(x=NMS1, y=NMS2, label = Variables), cex = 4, direction = "both", segment.size = 0.25, max.overlaps=25)



#By Site
ggplot(nmsdf, aes(x=NMS1, y=NMS2))+
  geom_point(size=2, alpha=0.2,aes(fill=Area, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#000000","#053061","#2166ac", "#4393c3",
                             "#92c5de","#d1e5f0","#f7f7f7","#fddbc7",
                             "#f4a582","#d6604d", "#b2182b", "#67001f"), "Area")+
  scale_color_manual(values=c("#000000","#053061","#2166ac", "#4393c3",
                             "#92c5de","#d1e5f0","#f7f7f7","#fddbc7",
                             "#f4a582","#d6604d", "#b2182b", "#67001f"), "Area")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, aes(color=Area), size=1.1, alpha=0.7)+
   ggtitle("Community Composition MPA Group")+
   geom_segment(data = sig.env.scrs, aes(x=0, xend=NMS1, y=0, yend=NMS2), colour = "grey50", lwd=0.5)+ #add vector arrows of significant species
  ggrepel::geom_text_repel(data = sig.env.scrs, aes(x=NMS1, y=NMS2, label = Variables), cex = 4, direction = "both", segment.size = 0, max.overlaps=30)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

#By Year 
ggplot(nmsdf, aes(x=NMS1, y=NMS2))+
  geom_point(size=2, alpha=0.2,aes(fill=Area, shape=Site))+
  scale_shape_manual(values=c(21,22), "Site")+
  scale_fill_manual(values=c("#67001f",
                        "#b2182b","#d6604d","#f4a582","#fddbc7",
                        "#f7f7f7","#d1e5f0","#92c5de","#4393c3",
                        "#2166ac","#053061", "#000000"), "Area")+
  scale_color_manual(values=c("#67001f",
                        "#b2182b","#d6604d","#f4a582","#fddbc7",
                        "#f7f7f7","#d1e5f0","#92c5de","#4393c3",
                        "#2166ac","#053061", "#000000"), "Area")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_ellipse(level=0.95, aes(color=Year1), size=1.1, alpha=0.7)+
   ggtitle("All sites by Year")

#Simper anlaysis - this analysis tells you what species are driving the dissimilarity between groups - here it will tell you for a year comparision the to species driving variation -

#This is the cummulative contribution - so the 1st species is the most important (the greatest contribution) and the 2nd (combined 1+2 contribution) and so on...

(biomsim<-with(bpueccmetay, simper(bpueccdatay, mhw)))
#summary(biomsim)

##Examine diversity without Blues 
cpuecc2b<-cpuecc1y%>%
  select(Year, Area, Site, species, Area_km2, Cluster, Cluster.Area_km2, Paired.latitude, maxsst, npp, species, meancpue)%>%
  filter(species!="Blue.Deacon.Rockfish")%>%
  spread(species, meancpue)

cpueccmetab<-cpuecc2b[,c(1:9)]
cpueccdatab<-cpuecc2b[,-c(1:9)]


#calculating fisher's alpha diversity, shannon diversity and simpson diversity
shan<-diversity(cpueccdatab, index="shannon")
simp<-diversity(cpueccdatab, index = "simpson")

#calcualte species richness
S <- specnumber(cpueccdatab)
#pielou's eveness
J <- shan/log(S)

#add richness and eveness to df
cpueccmetab$richness<-S
cpueccmetab$eveness<-J
cpueccmetab$shannon<-shan
cpueccmetab$simpson<-simp




cpueccb<-cpueccmetab%>%
  group_by(Year, Site)%>%
  summarize(meanrich=mean(richness),  lowerrich = mean(richness) - qt(1- alpha/2, (n() - 1))*sd(richness)/sqrt(n()),
                       upperrich = mean(richness) + qt(1- alpha/2, (n() - 1))*sd(richness)/sqrt(n()), meanshan=mean(shannon),  lowershan = mean(shannon) - qt(1- alpha/2, (n() - 1))*sd(shannon)/sqrt(n()),
                       uppershan = mean(shannon) + qt(1- alpha/2, (n() - 1))*sd(shannon)/sqrt(n()),
            meaneven=mean(eveness),  lowereven = mean(eveness) - qt(1- alpha/2, (n() - 1))*sd(eveness)/sqrt(n()),
                       uppereven = mean(eveness) + qt(1- alpha/2, (n() - 1))*sd(eveness)/sqrt(n()))



 ccrichb<- ggplot(cpueccb, aes(Year, meanrich, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    geom_line(aes(color=Site))+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Species richness")+
  geom_errorbar(aes(ymax=upperrich, ymin=lowerrich), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

 ccshanb<-ggplot(cpueccb, aes(Year, meanshan, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    geom_line(aes(color=Site))+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Shannon-Wiener diversity")+
   ylim(1, 2.25)+
  geom_errorbar(aes(ymax=uppershan, ymin=lowershan), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
  
 ccevenb<-ggplot(cpueccb, aes(Year, meaneven, fill=Site, shape=Site))+
 geom_point(size=3, position=position_dodge(0.2))+
  scale_shape_manual(values=c(21,23))+
    geom_line(aes(color=Site))+
    scale_fill_manual(values=c("#b2182b", "#2166ac"))+
     scale_color_manual(values=c("#b2182b", "#2166ac"))+
  ylab("Pielou's evenness")+
  geom_errorbar(aes(ymax=uppereven, ymin=lowereven), position = position_dodge(0.2), width=0)+
  theme(plot.title = element_text(size = 16, face = "bold"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
  
plot_grid(ccrichb, ccevenb, ccshanb, ncol=1) 
```


